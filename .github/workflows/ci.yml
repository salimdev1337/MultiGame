name: CI - Test & Analyze

# TRIGGER: When does this workflow run?
on:
  push:
    branches: [ main, master, develop ]  # Run on pushes to these branches
  pull_request:
    branches: [ main, master, develop ]  # Run on PRs to these branches
  workflow_dispatch:  # Allows manual trigger from GitHub UI

# JOBS: The actual work to be done
jobs:
  # Job 1: Test the Flutter app
  test:
    name: Run Tests & Analyze Code
    runs-on: ubuntu-latest  # Use Ubuntu Linux (free on GitHub)
    
    steps:
      # STEP 1: Get the code from your repository
      - name:  Checkout code
        uses: actions/checkout@v4
        
      # STEP 2: Install Java (required for Android builds)
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      # STEP 3: Install Flutter
      - name:  Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'  # Use latest stable version
          channel: 'stable'
          cache: true  # Cache Flutter SDK to speed up future runs
          
      # STEP 4: Display Flutter version (for debugging)
      - name:  Flutter doctor
        run: flutter doctor -v

      # STEP 5: Setup Firebase config from repository secrets
      - name:  Setup Firebase config
        env:
          FIREBASE_OPTIONS_DART_B64: ${{ secrets.FIREBASE_OPTIONS_DART }}
        run: echo "$FIREBASE_OPTIONS_DART_B64" | base64 --decode > lib/config/firebase_options.dart

      # STEP 6: Get all dependencies from pubspec.yaml
      - name:  Get dependencies
        run: flutter pub get

      # STEP 6b: Install Firebase CLI and start emulators
      # Auth (9099) + Firestore (8080) run in background for integration tests.
      # Unit tests using fake_cloud_firestore are unaffected.
      - name: Setup Firebase emulators
        run: |
          npm install -g firebase-tools
          firebase emulators:start --only auth,firestore --project multigame-54c9b &
          # Wait for emulators to be ready
          npx wait-on tcp:9099 tcp:8080 --timeout 30000

      # STEP 7: Check code formatting
      - name:  Check formatting
        run: dart format --set-exit-if-changed .
        continue-on-error: true  # Don't fail if formatting is off, just warn

      # STEP 8: Analyze code for issues
      - name:  Analyze code
        run: flutter analyze
        env:
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}

      # STEP 9: Run all unit + integration tests
      # Emulator env vars tell the Firebase SDK to hit localhost instead of prod.
      - name:  Run tests
        env:
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
          FIRESTORE_EMULATOR_HOST: localhost:8080
        run: flutter test --coverage

      # STEP 10: Upload code coverage report
      - name:  Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false  # Don't fail if coverage upload fails

      # STEP 11: Generate coverage report (optional)
      - name:  Coverage Report
        if: always()  # Run even if previous steps failed
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "Code coverage generated"
            echo "View detailed report in Codecov"
          else
            echo " No coverage data found"
          fi

  # Job 2: Check for dependency vulnerabilities
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
        
      - name:  Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true
          
      - name:  Get dependencies
        run: flutter pub get
        
      # Check for outdated or vulnerable packages
      - name:  Check pub outdated
        run: flutter pub outdated
        continue-on-error: true  # Just informational
