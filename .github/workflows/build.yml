# =============================================================================
# BUILD WORKFLOW - Multi-Platform Builds
# =============================================================================
# PURPOSE: Build the app for Android, Windows, and Web platforms
# This runs on push to main and when you create a tag/release
#
# WHAT YOU'LL LEARN:
# - Building for multiple platforms
# - Creating artifacts (downloadable builds)
# - Matrix builds (running same job with different parameters)
# - Uploading build outputs
# =============================================================================

name: Build - Multi-Platform

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Manual trigger

jobs:
  # Job 1: Build Android APK
  build-android:
    name: ðŸ¤– Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Get dependencies
        run: flutter pub get
        
      - name: ðŸ”¨ Build Android APK
        env:
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: flutter build apk --release --dart-define=UNSPLASH_ACCESS_KEY=$UNSPLASH_ACCESS_KEY
        
      - name: ðŸ”¨ Build Android App Bundle (for Play Store)
        env:
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: flutter build appbundle --release --dart-define=UNSPLASH_ACCESS_KEY=$UNSPLASH_ACCESS_KEY
        
      # Upload the built APK so you can download it
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          
      - name: ðŸ“¤ Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-appbundle
          path: build/app/outputs/bundle/release/app-release.aab

  # Job 2: Build Windows executable
  build-windows:
    name: ðŸªŸ Build Windows
    runs-on: windows-latest  # Windows machine required for Windows builds
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Get dependencies
        run: flutter pub get
        
      - name: ðŸ”¨ Build Windows
        env:
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: flutter build windows --release --dart-define=UNSPLASH_ACCESS_KEY=$UNSPLASH_ACCESS_KEY
        
      # Zip the entire build folder
      - name: ðŸ“¦ Package Windows build
        run: |
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath puzzle-windows.zip
        
      - name: ðŸ“¤ Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: puzzle-windows.zip

  # Job 3: Build Web version
  build-web:
    name: ðŸŒ Build Web
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Get dependencies
        run: flutter pub get
        
      - name: ðŸ”¨ Build Web
        env:
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: flutter build web --release --base-href "/puzzle/" --dart-define=UNSPLASH_ACCESS_KEY=$UNSPLASH_ACCESS_KEY
        
      - name: ðŸ“¤ Upload Web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/

  # Job 4: Summary of all builds
  build-summary:
    name: ðŸ“‹ Build Summary
    needs: [build-android, build-windows, build-web]
    runs-on: ubuntu-latest
    if: always()  # Run even if some builds fail
    
    steps:
      - name: ðŸ“Š Create summary
        run: |
          echo "## ðŸŽ‰ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Android  | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows  | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web      | ${{ needs.build-web.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download artifacts from the Actions tab" >> $GITHUB_STEP_SUMMARY
