# ğŸ”¥ Firebase Setup Guide - Step by Step

Follow these steps carefully. We'll do this together!

---

## âœ… Step 1: Install FlutterFire CLI (COMPLETE THIS FIRST)

The FlutterFire CLI helps configure Firebase for your Flutter app automatically.

### Windows PowerShell Commands:

```powershell
# Install FlutterFire CLI
dart pub global activate flutterfire_cli

# Verify installation
flutterfire --version
```

**Expected Output:** Should show version like `1.x.x`

**Troubleshooting:**
- If you get "command not found", add Dart global packages to PATH:
  - Path: `C:\Users\YourUsername\AppData\Local\Pub\Cache\bin`
  - Or run: `flutter pub global run flutterfire_cli:flutterfire`

---

## âœ… Step 2: Create Firebase Project (Do this in browser)

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Click **"Add project"** or **"Create a project"**
3. **Project Name**: Enter `puzzle-game` (or your preferred name)
4. **Google Analytics**: 
   - You can **disable** it for now (simplifies setup)
   - Or enable it (optional for tracking)
5. Click **"Create project"**
6. Wait for project creation (takes ~30 seconds)
7. Click **"Continue"** when done

**ğŸ¯ Checkpoint:** You should now see your Firebase project dashboard

---

## âœ… Step 3: Enable Authentication

1. In Firebase Console, click **"Authentication"** in left sidebar
2. Click **"Get started"**
3. Go to **"Sign-in method"** tab
4. Enable **"Anonymous"** provider:
   - Click on "Anonymous"
   - Toggle "Enable"
   - Click "Save"
5. Enable **"Google"** provider (optional but recommended):
   - Click on "Google"
   - Toggle "Enable"
   - Enter project support email
   - Click "Save"

**ğŸ¯ Checkpoint:** You should see "Anonymous" and "Google" as enabled

---

## âœ… Step 4: Create Firestore Database

1. In Firebase Console, click **"Firestore Database"** in left sidebar
2. Click **"Create database"**
3. **Security rules**: Select **"Start in test mode"** (we'll secure it later)
4. **Location**: Choose closest region (e.g., `us-central1` for US, `europe-west1` for Europe)
5. Click **"Enable"**
6. Wait for database creation (~30 seconds)

**ğŸ¯ Checkpoint:** You should see empty Firestore database with "Start collection" button

---

## âœ… Step 5: Connect Firebase to Flutter App

**Run this command in your project directory:**

```powershell
# Make sure you're in the project folder
cd C:\Users\salim\OneDrive\Bureau\bootcamp\flutter\puzzle

# Configure Firebase for all platforms
flutterfire configure
```

### What this command does:
1. Prompts you to select your Firebase project
2. Asks which platforms to configure (Android, iOS, Web, Windows)
3. Creates `firebase_options.dart` file automatically
4. Updates platform-specific configuration files

### Follow the prompts:
```
? Select a Firebase project to configure your Flutter application with
  > puzzle-game (or your project name)

? Which platforms should your configuration support?
  > âœ“ android
  > âœ“ ios
  > âœ“ web
  > âœ“ windows
```

**ğŸ¯ Checkpoint:** 
- File created: `lib/firebase_options.dart`
- Android: `android/app/google-services.json`
- iOS: `ios/Runner/GoogleService-Info.plist`

---

## âœ… Step 6: Install Dependencies

```powershell
flutter pub get
```

**ğŸ¯ Checkpoint:** Should show "Got dependencies!"

---

## âœ… Step 7: Initialize Firebase in App

I'll create the initialization code for you now...

---

---

## âœ… Step 7: Secure firebase_options.dart

**IMPORTANT:** The `firebase_options.dart` file contains project-specific configuration and should **NOT** be committed to version control.

### Add to .gitignore

```bash
# Check if already gitignored
git check-ignore lib/config/firebase_options.dart

# If not ignored, add it
echo "lib/config/firebase_options.dart" >> .gitignore
```

### Create Template File

Create a template for reference:

**File:** `lib/config/firebase_options.dart.template`

```dart
// Template for firebase_options.dart
// DO NOT commit actual firebase_options.dart to version control
// Generate using: flutterfire configure

import 'package:firebase_core/firebase_core.dart';

class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    // This file is generated by flutterfire configure
    // Run: dart pub global activate flutterfire_cli
    // Then: flutterfire configure
    throw UnsupportedError(
      'Firebase options not configured. Run: flutterfire configure',
    );
  }
}
```

Save this template and commit it to git. Team members can use it as reference.

**ğŸ¯ Checkpoint:**
- `firebase_options.dart` is in .gitignore
- `firebase_options.dart.template` is committed as reference

---

## âœ… Step 8: Deploy Firestore Security Rules

Firestore security rules protect your database from unauthorized access.

### Install Firebase CLI

```powershell
# Install Node.js first (if not installed): https://nodejs.org/

# Install Firebase CLI globally
npm install -g firebase-tools

# Verify installation
firebase --version
```

### Login to Firebase

```powershell
firebase login
```

This will open a browser window for authentication.

### Initialize Firestore

```powershell
# In your project directory
firebase init firestore
```

**Follow the prompts:**
1. Select your Firebase project
2. Use default `firestore.rules` for rules file
3. Use default `firestore.indexes.json` for indexes

### Deploy Security Rules

**File:** `firestore.rules` (should already exist in project root)

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // User scores collection
    match /user_scores/{userId} {
      // Users can read their own scores
      allow read: if isAuthenticated() && isOwner(userId);

      // Users can write their own scores with validation
      allow create, update: if isAuthenticated()
                            && isOwner(userId)
                            && validateScoreData(request.resource.data);

      // No deletes (data retention)
      allow delete: if false;
    }

    // Leaderboard collection (read-only for clients)
    match /leaderboard/{document} {
      allow read: if isAuthenticated();
      allow write: if false; // Only server can write
    }

    // Validation function for score data
    function validateScoreData(data) {
      return data.keys().hasAll(['score', 'displayName', 'timestamp', 'gameType'])
          && data.score is int
          && data.score >= 0
          && data.score <= 999999
          && data.displayName is string
          && data.displayName.size() >= 3
          && data.displayName.size() <= 20
          && data.gameType in ['puzzle', '2048', 'snake', 'infinite_runner'];
    }
  }
}
```

**Deploy the rules:**

```powershell
# Deploy only Firestore rules
firebase deploy --only firestore:rules

# Or deploy everything
firebase deploy
```

**ğŸ¯ Checkpoint:**
- Firebase CLI installed and logged in
- Security rules deployed to Firebase
- Rules visible in Firebase Console â†’ Firestore Database â†’ Rules

---

## âœ… Step 9: Test the Setup

### Test Authentication

```dart
// This should work in your app
import 'package:firebase_auth/firebase_auth.dart';

final user = await FirebaseAuth.instance.signInAnonymously();
print('User ID: ${user.user?.uid}');
```

### Test Firestore Write

```dart
// This should work (writing own data)
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';

final userId = FirebaseAuth.instance.currentUser?.uid;
await FirebaseFirestore.instance
  .collection('user_scores')
  .doc(userId)
  .set({
    'score': 100,
    'displayName': 'Player',
    'timestamp': FieldValue.serverTimestamp(),
    'gameType': 'puzzle',
  });
```

### Test Security Rules

Try reading another user's data (should fail):

```dart
// This should FAIL with permission denied
try {
  final doc = await FirebaseFirestore.instance
    .collection('user_scores')
    .doc('another_user_id')  // Different user ID
    .get();
} catch (e) {
  print('Expected error: $e'); // Should be permission denied
}
```

**ğŸ¯ Checkpoint:**
- Anonymous authentication works
- Can write own data
- Cannot read other users' data (security works!)

---

## Current Status Checklist

- [ ] Step 1: FlutterFire CLI installed
- [ ] Step 2: Firebase project created
- [ ] Step 3: Authentication enabled (Anonymous)
- [ ] Step 4: Firestore database created
- [ ] Step 5: Firebase configured (firebase_options.dart generated)
- [ ] Step 6: Dependencies installed
- [ ] Step 7: firebase_options.dart secured (gitignored)
- [ ] Step 8: Security rules deployed
- [ ] Step 9: Setup tested and working

---

## ğŸ†˜ Common Issues & Solutions

### Issue 1: FlutterFire command not found
**Solution:**
```powershell
# Run directly without adding to PATH
flutter pub global run flutterfire_cli:flutterfire configure
```

### Issue 2: "Firebase project not found"
**Solution:**
- Make sure you're logged into Google account
- Run: `firebase login` (if you have Firebase CLI)
- Or select project manually in flutterfire configure

### Issue 3: Permission denied
**Solution:**
- Run PowerShell as Administrator
- Or use `flutter pub global run flutterfire_cli:flutterfire configure`

### Issue 4: Package conflicts
**Solution:**
```powershell
flutter clean
flutter pub get
```

### Issue 5: "Permission denied" when writing to Firestore
**Solution:**
- Check that security rules are deployed: `firebase deploy --only firestore:rules`
- Verify user is authenticated: `FirebaseAuth.instance.currentUser != null`
- Check that user ID matches document ID in `user_scores` collection

### Issue 6: firebase_options.dart committed to git
**Solution:**
```bash
# Remove from git tracking
git rm --cached lib/config/firebase_options.dart

# Add to .gitignore
echo "lib/config/firebase_options.dart" >> .gitignore

# Commit the changes
git add .gitignore
git commit -m "Stop tracking firebase_options.dart"
```

---

## ğŸ“ Security Best Practices

### DO:
- âœ… Add `firebase_options.dart` to `.gitignore`
- âœ… Deploy security rules before going to production
- âœ… Use anonymous auth for casual games
- âœ… Validate all data in security rules
- âœ… Test security rules thoroughly
- âœ… Keep Firebase CLI updated: `npm update -g firebase-tools`

### DON'T:
- âŒ Commit `firebase_options.dart` to version control
- âŒ Use "test mode" rules in production
- âŒ Skip authentication (even anonymous)
- âŒ Allow public read/write access without validation
- âŒ Hardcode API keys in your code
- âŒ Share Firebase Console credentials

---

## ğŸ”— Additional Resources

- [Firebase Documentation](https://firebase.google.com/docs)
- [FlutterFire Documentation](https://firebase.flutter.dev/)
- [Firestore Security Rules Guide](https://firebase.google.com/docs/firestore/security/get-started)
- [Firebase CLI Reference](https://firebase.google.com/docs/cli)
- [Project Security Documentation](SECURITY.md)

---

## ğŸ“ Notes

- Keep Firebase Console open in browser during setup
- Don't close terminal during configuration
- Test each step before proceeding to the next
- If stuck, check the Common Issues section above
- Review [docs/SECURITY.md](SECURITY.md) for complete security guidelines

**Ready to start? Begin with Step 1!** ğŸš€
